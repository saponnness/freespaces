{% extends 'base.html' %}

{% block title %}Complete Your Profile - Freespaces{% endblock %}

{% block content %}
<!-- Add Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<div class="max-w-2xl mx-auto px-4">
    <!-- Welcome Header -->
    <div class="glass-effect rounded-3xl shadow-lg p-8 mb-8">
        <div class="text-center">
            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-amber-400 to-pink-400 flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
            </div>
            <h1 class="text-3xl font-bold gradient-text mb-2">Welcome to Freespaces!</h1>
            <p class="text-gray-600">Let's set up your profile to get started</p>
            
            {% if google_data.picture %}
                <div class="mt-6">
                    <img src="{{ google_data.picture }}" alt="Your Google Profile" 
                         class="w-16 h-16 rounded-full mx-auto border-4 border-white shadow-lg">
                    <p class="text-sm text-gray-500 mt-2">Connected with Google</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Profile Setup Form -->
    <div class="glass-effect rounded-3xl shadow-lg p-8">
        <h2 class="text-2xl font-bold gradient-text mb-6">Choose Your Username</h2>
        
        <form method="post" class="space-y-6" id="profile-setup-form">
            {% csrf_token %}
            
            <!-- Username Field -->
            <div>
                <label class="block text-gray-700 text-sm font-semibold mb-2">
                    Username
                    <span class="text-red-500">*</span>
                </label>
                <div class="relative w-full">
                    <input type="text"
                           name="username"
                           id="username-input"
                           value="{{ suggested_username }}"
                           placeholder="your_username"
                           class="w-full pl-8 pr-4 py-3 rounded-2xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-400 focus:border-transparent transition-all bg-white/80"
                           required>
                    <span class="absolute left-3 text-gray-500 font-semibold pointer-events-none select-none"
                          style="top: 0.75rem; line-height: 1.5rem; font-size: 1rem;">@</span>
                    <div id="username-validation" class="absolute right-3 top-1/2 transform -translate-y-1/2 z-10">
                        <!-- Validation icon will appear here -->
                    </div>
                </div>
                <div id="username-feedback" class="mt-2 text-sm hidden">
                    <!-- Validation feedback will appear here -->
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    3-20 characters, letters, numbers, and underscores only
                </p>
            </div>

            <!-- Profile Picture Section -->
            <div>
                <label class="block text-gray-700 text-sm font-semibold mb-2">
                    Profile Picture
                    <span class="text-gray-400">(Optional)</span>
                </label>

                <div class="flex items-center space-x-4">
                    <!-- Current/Google Picture with Edit Button -->
                    <div class="flex-shrink-0 relative">
                        {% if google_data.picture %}
                            <img src="{{ google_data.picture }}" alt="Profile"
                                 class="w-20 h-20 rounded-full border-4 border-white shadow-lg object-cover" id="profile-preview">
                        {% else %}
                            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-purple-400 to-blue-400 flex items-center justify-center shadow-lg border-4 border-white" id="profile-preview">
                                <span class="text-white text-xl font-bold">
                                    {{ user.first_name|first|upper|default:"U" }}
                                </span>
                            </div>
                        {% endif %}

                        <!-- Edit Button -->
                        <button type="button" onclick="document.getElementById('setup-avatar-upload').click()"
                                class="absolute -bottom-1 -right-1 bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-blue-600 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </button>

                        <!-- Hidden file input -->
                        <input type="file" id="setup-avatar-upload" accept="image/*" class="hidden">
                    </div>

                    <!-- Upload Instructions -->
                    <div class="flex-1">
                        {% if google_data.picture %}
                            <p class="text-sm text-gray-600 mb-2">Using your Google profile picture</p>
                            <p class="text-xs text-gray-500">Click the camera icon to upload a different picture with cropping</p>
                        {% else %}
                            <p class="text-sm text-gray-600 mb-2">Upload a profile picture</p>
                            <p class="text-xs text-gray-500">Click the camera icon to upload and crop your picture</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="pt-4">
                <button type="submit" 
                        id="setup-submit-btn"
                        class="w-full bg-gradient-to-r from-amber-400 to-pink-400 text-white py-3 px-6 rounded-2xl hover:shadow-lg transition-all duration-200 font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                    Complete Setup
                </button>
            </div>
        </form>
        
        <!-- Skip Option -->
        <div class="mt-6 text-center">
            <p class="text-gray-600 text-sm">
                You can always update your profile later in 
                <a href="{% url 'accounts:account_settings' %}" class="text-amber-600 hover:text-pink-600 font-semibold transition-colors">
                    account settings
                </a>
            </p>
        </div>
    </div>
</div>

<!-- Image Cropping Modal -->
<div id="setupCropModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center" style="user-select: none;">
    <div class="bg-white rounded-lg max-w-lg w-full mx-4" onclick="event.stopPropagation();">
        <div class="p-6">
            <h3 class="text-lg font-semibold mb-4">Crop Your Profile Picture</h3>
            <div class="mb-4 overflow-hidden" style="max-height: 400px;">
                <img id="setupCropImage" class="max-w-full block" style="max-height: 400px;">
            </div>
            <div class="text-sm text-gray-600 mb-4">
                Drag to reposition • Scroll to zoom • Drag corners to resize crop area
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="closeSetupCropModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                    Cancel
                </button>
                <button onclick="saveSetupCroppedImage()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    Save Picture
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for cropped image -->
<form id="setup-cropped-form" method="post" action="{% url 'accounts:update_avatar' %}" class="hidden">
    {% csrf_token %}
    <input type="hidden" id="setup-cropped-image-data" name="cropped_image">
</form>

<!-- Add Cropper.js Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

{% endblock %}
